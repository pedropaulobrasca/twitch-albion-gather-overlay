<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Albion Overlay - Painel de Controle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #282a36;
            color: #f8f8f2;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-top: 20px;
        }
        .card {
            background-color: #44475a;
            border: none;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .card-header {
            background-color: #6272a4;
            color: #f8f8f2;
            font-weight: bold;
            border-top-left-radius: 10px !important;
            border-top-right-radius: 10px !important;
        }
        .nav-tabs .nav-link {
            color: #f8f8f2;
            border: none;
        }
        .nav-tabs .nav-link.active {
            background-color: #44475a;
            color: #ff79c6;
            border: none;
            border-bottom: 2px solid #ff79c6;
        }
        .form-control, .form-select {
            background-color: #383a59;
            border: 1px solid #6272a4;
            color: #f8f8f2;
        }
        .form-control:focus, .form-select:focus {
            background-color: #383a59;
            color: #f8f8f2;
            border-color: #bd93f9;
            box-shadow: 0 0 0 0.25rem rgba(189, 147, 249, 0.25);
        }
        .btn-primary {
            background-color: #bd93f9;
            border-color: #bd93f9;
        }
        .btn-primary:hover {
            background-color: #a77deb;
            border-color: #a77deb;
        }
        .btn-success {
            background-color: #50fa7b;
            border-color: #50fa7b;
            color: #282a36;
        }
        .btn-success:hover {
            background-color: #3ece62;
            border-color: #3ece62;
            color: #282a36;
        }
        .btn-danger {
            background-color: #ff5555;
            border-color: #ff5555;
        }
        .btn-danger:hover {
            background-color: #e64747;
            border-color: #e64747;
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        .log-container {
            background-color: #282a36;
            border-radius: 5px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }
        .activity-card {
            background-color: #383a59;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            padding: 15px;
            border: 2px solid #6272a4;
        }
        .activity-card:hover {
            border-color: #bd93f9;
        }
        .icon-preview {
            width: 50px;
            height: 50px;
            background-color: #282a36;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            overflow: hidden;
        }
        .icon-preview img {
            max-width: 40px;
            max-height: 40px;
        }
        .help-text {
            font-size: 0.8rem;
            color: #bbbbbb;
            margin-top: 5px;
        }
        .code-block {
            background-color: #282a36;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            margin: 10px 0;
        }
        .item-code-input {
            font-family: monospace;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Albion Overlay - Painel de Controle</h1>
            <div>
                <span id="statusBadge" class="status-badge bg-danger">Offline</span>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab" aria-controls="activities" aria-selected="false">Atividades</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Configurações</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab" aria-controls="help" aria-selected="false">Ajuda</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="card">
                    <div class="card-header">Controle do Servidor</div>
                    <div class="card-body">
                        <div class="d-flex gap-2 mb-4">
                            <button id="startServerBtn" class="btn btn-success">Iniciar Servidor</button>
                            <button id="stopServerBtn" class="btn btn-danger" disabled>Parar Servidor</button>
                            <button id="openOverlayBtn" class="btn btn-primary">Abrir Overlay no Navegador</button>
                        </div>
                        
                        <h5>URL do Overlay para OBS:</h5>
                        <div class="code-block" id="overlayUrl">http://localhost:3001/overlay</div>
                        <p class="help-text">Adicione esta URL como uma "Fonte de Navegador" no OBS. Marque a opção "Fundo transparente".</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Logs do Servidor</div>
                    <div class="card-body">
                        <div id="logContainer" class="log-container"></div>
                    </div>
                </div>
            </div>

            <!-- Activities Tab -->
            <div class="tab-pane fade" id="activities" role="tabpanel" aria-labelledby="activities-tab">
                <div class="card">
                    <div class="card-header">Configuração de Atividades</div>
                    <div class="card-body">
                        <p>Configure os valores para cada atividade que pode ser bloqueada pelos espectadores:</p>
                        
                        <div id="activitiesList"></div>
                        
                        <div class="d-flex justify-content-between mt-3">
                            <button id="saveActivitiesBtn" class="btn btn-primary">Salvar Atividades</button>
                            <button id="resetActivitiesBtn" class="btn btn-outline-danger">Resetar para Padrão</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="card">
                    <div class="card-header">Configurações da Twitch</div>
                    <div class="card-body">
                        <form id="settingsForm">
                            <div class="mb-3">
                                <label for="twitchUsername" class="form-label">Nome de usuário da Twitch</label>
                                <input type="text" class="form-control" id="twitchUsername" placeholder="seu_canal">
                                <div class="help-text">O nome do seu canal da Twitch</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="twitchOAuthToken" class="form-label">Token OAuth da Twitch</label>
                                <input type="password" class="form-control" id="twitchOAuthToken" placeholder="oauth:xxxxxxxxxxxxx">
                                <div class="help-text">
                                    <a href="https://twitchapps.com/tmi/" target="_blank" class="text-info">Obter token OAuth aqui</a>
                                    (formato: oauth:xxxxxxxxxxxxx)
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="port" class="form-label">Porta do Servidor</label>
                                <input type="number" class="form-control" id="port" placeholder="3001" min="1024" max="65535" value="3001">
                                <div class="help-text">Porta local para o servidor (padrão: 3001)</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="autoStart" class="form-check-label">Iniciar servidor automaticamente</label>
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" id="autoStart">
                                    <div class="help-text">Iniciar o servidor automaticamente ao abrir o aplicativo</div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Salvar Configurações</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
                <div class="card">
                    <div class="card-header">Como Usar</div>
                    <div class="card-body">
                        <h5>Configuração Básica</h5>
                        <ol>
                            <li>Na aba <strong>Configurações</strong>, adicione seu nome de usuário da Twitch e token OAuth.</li>
                            <li>Na aba <strong>Atividades</strong>, configure os valores de bits e tempos para cada atividade.</li>
                            <li>Na aba <strong>Dashboard</strong>, clique em "Iniciar Servidor".</li>
                        </ol>

                        <h5>Configuração no OBS</h5>
                        <ol>
                            <li>No OBS, adicione uma nova "Fonte de Navegador".</li>
                            <li>Coloque a URL do overlay: <code>http://localhost:3001/overlay</code></li>
                            <li>Marque a opção "Fundo transparente".</li>
                            <li>Ajuste a largura para aproximadamente 200px e a altura para 600px.</li>
                        </ol>

                        <h5>Comandos de Chat</h5>
                        <p>Os espectadores podem usar o comando <code>!bloqueios</code> no chat para ver quais atividades estão bloqueadas no momento.</p>

                        <h5>Teste sem usar bits reais</h5>
                        <p>Use o botão "Abrir Overlay no Navegador" e acesse a URL <code>http://localhost:3001/teste/bits/[atividade]/[quantidade]</code> para testar sem usar bits reais.</p>
                        <p>Exemplo: <code>http://localhost:3001/teste/bits/mining/50</code></p>
                        
                        <h5>Como o Servidor Funciona</h5>
                        <p>O aplicativo gerencia automaticamente as configurações e não é necessário criar um arquivo .env manualmente. Quando você clica em "Iniciar Servidor", o aplicativo:</p>
                        <ol>
                            <li>Cria automaticamente um arquivo .env temporário com suas configurações</li>
                            <li>Atualiza o arquivo config.json com as atividades configuradas</li>
                            <li>Inicia o servidor Node.js em segundo plano</li>
                            <li>Exibe os logs do servidor na aba Dashboard</li>
                        </ol>
                        <p>Todas as configurações são salvas localmente e não precisam ser definidas novamente quando você reiniciar o aplicativo.</p>
                        <p>Se você marcar a opção "Iniciar servidor automaticamente" nas configurações, o servidor iniciará sempre que o aplicativo for aberto.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Comunicação com o processo principal do Electron
        const { ipcRenderer } = require('electron');
        
        // Elementos DOM
        const statusBadge = document.getElementById('statusBadge');
        const startServerBtn = document.getElementById('startServerBtn');
        const stopServerBtn = document.getElementById('stopServerBtn');
        const openOverlayBtn = document.getElementById('openOverlayBtn');
        const logContainer = document.getElementById('logContainer');
        const overlayUrl = document.getElementById('overlayUrl');
        const activitiesList = document.getElementById('activitiesList');
        const saveActivitiesBtn = document.getElementById('saveActivitiesBtn');
        const resetActivitiesBtn = document.getElementById('resetActivitiesBtn');
        const settingsForm = document.getElementById('settingsForm');
        const twitchUsername = document.getElementById('twitchUsername');
        const twitchOAuthToken = document.getElementById('twitchOAuthToken');
        const portInput = document.getElementById('port');
        const autoStart = document.getElementById('autoStart');
        
        // Templates de atividades padrão
        const defaultActivities = {
            mining: {
                bits: 50,
                durationMinutes: 5,
                icon: "pickaxe.png",
                label: "Mineração",
                itemCode: "T8_2H_TOOL_PICK"
            },
            fishing: {
                bits: 40,
                durationMinutes: 5,
                icon: "fishing-rod.png",
                label: "Pesca",
                itemCode: "T8_2H_TOOL_FISHINGROD"
            },
            woodcutting: {
                bits: 45,
                durationMinutes: 5,
                icon: "axe.png",
                label: "Corte de Madeira",
                itemCode: "T8_2H_TOOL_AXE"
            },
            skinning: {
                bits: 45,
                durationMinutes: 5,
                icon: "skinning-knife.png", 
                label: "Esfolamento",
                itemCode: "T8_2H_TOOL_KNIFE"
            },
            herbalism: {
                bits: 40,
                durationMinutes: 5,
                icon: "sickle.png",
                label: "Herbalismo",
                itemCode: "T8_2H_TOOL_SICKLE"
            },
            quarrying: {
                bits: 100,
                durationMinutes: 5,
                icon: "hammer.png",
                label: "Pedreira",
                itemCode: "T8_2H_TOOL_HAMMER"
            }
        };
        
        // Estado da aplicação
        let activities = {};
        
        // Funções de Inicialização
        function init() {
            // Solicitar status do servidor
            ipcRenderer.send('get-server-status');
            
            // Solicitar configurações salvas
            ipcRenderer.send('get-settings');
            
            // Listeners de eventos
            startServerBtn.addEventListener('click', () => {
                ipcRenderer.send('start-server');
            });
            
            stopServerBtn.addEventListener('click', () => {
                ipcRenderer.send('stop-server');
            });
            
            openOverlayBtn.addEventListener('click', () => {
                ipcRenderer.send('open-overlay');
            });
            
            saveActivitiesBtn.addEventListener('click', saveActivities);
            resetActivitiesBtn.addEventListener('click', resetActivities);
            settingsForm.addEventListener('submit', saveSettings);
        }
        
        // Funções de renderização
        function renderActivities() {
            activitiesList.innerHTML = '';
            
            Object.entries(activities).forEach(([key, activity]) => {
                const activityCard = document.createElement('div');
                activityCard.className = 'activity-card';
                
                // Definir o código de item caso não exista
                if (!activity.itemCode) {
                    const defaultCodes = {
                        'mining': 'T8_2H_TOOL_PICK',
                        'fishing': 'T8_2H_TOOL_FISHINGROD',
                        'woodcutting': 'T8_2H_TOOL_AXE',
                        'skinning': 'T8_2H_TOOL_KNIFE',
                        'herbalism': 'T8_2H_TOOL_SICKLE',
                        'quarrying': 'T8_2H_TOOL_HAMMER'
                    };
                    activity.itemCode = defaultCodes[key] || `T8_2H_TOOL_${key.toUpperCase()}`;
                }
                
                activityCard.innerHTML = `
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-preview">
                            <img src="https://render.albiononline.com/v1/item/${activity.itemCode}" alt="${activity.label}" onerror="this.src='https://i.imgur.com/vEUZ3ZN.png'" />
                        </div>
                        <div>
                            <h5>${activity.label}</h5>
                            <small class="text-muted">${key}</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Quantidade de Bits</label>
                            <input type="number" class="form-control" data-key="${key}" data-property="bits" 
                                value="${activity.bits}" min="1" required>
                            <div class="help-text">Quantidade mínima de bits para bloquear esta atividade</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Duração (minutos)</label>
                            <input type="number" class="form-control" data-key="${key}" data-property="durationMinutes" 
                                value="${activity.durationMinutes}" min="1" required>
                            <div class="help-text">Duração do bloqueio em minutos</div>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Código do Item</label>
                            <input type="text" class="form-control item-code-input" data-key="${key}" data-property="itemCode" 
                                value="${activity.itemCode}" required>
                            <div class="help-text">Código do item no Albion Online</div>
                        </div>
                    </div>
                `;
                
                activitiesList.appendChild(activityCard);
                
                // Adicionar event listeners para as mudanças
                const inputs = activityCard.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('change', updateActivityValue);
                    
                    // Atualizar imagem quando o código do item muda
                    if (input.dataset.property === 'itemCode') {
                        input.addEventListener('change', (e) => {
                            const itemCode = e.target.value;
                            const imgContainer = e.target.closest('.activity-card').querySelector('.icon-preview img');
                            imgContainer.src = `https://render.albiononline.com/v1/item/${itemCode}`;
                        });
                    }
                });
            });
        }
        
        function updateOverlayUrl() {
            const port = portInput.value || 3001;
            overlayUrl.textContent = `http://localhost:${port}/overlay`;
        }
        
        function updateServerStatus(running) {
            if (running) {
                statusBadge.textContent = 'Online';
                statusBadge.className = 'status-badge bg-success';
                startServerBtn.disabled = true;
                stopServerBtn.disabled = false;
            } else {
                statusBadge.textContent = 'Offline';
                statusBadge.className = 'status-badge bg-danger';
                startServerBtn.disabled = false;
                stopServerBtn.disabled = true;
            }
        }
        
        // Funções de manipulação de dados
        function updateActivityValue(event) {
            const input = event.target;
            const key = input.dataset.key;
            const property = input.dataset.property;
            const value = input.type === 'number' ? parseInt(input.value, 10) : input.value;
            
            activities[key][property] = value;
        }
        
        function saveActivities() {
            ipcRenderer.send('save-activities', activities);
        }
        
        function resetActivities() {
            activities = JSON.parse(JSON.stringify(defaultActivities));
            renderActivities();
            saveActivities();
        }
        
        function saveSettings(event) {
            event.preventDefault();
            
            const settings = {
                twitchUsername: twitchUsername.value,
                twitchOAuthToken: twitchOAuthToken.value,
                port: parseInt(portInput.value, 10),
                autoStart: autoStart.checked
            };
            
            ipcRenderer.send('save-settings', settings);
            updateOverlayUrl();
        }
        
        // Comunicação IPC com o processo principal
        ipcRenderer.on('server-status', (event, running) => {
            updateServerStatus(running);
        });
        
        ipcRenderer.on('server-log', (event, log) => {
            const logLine = document.createElement('div');
            logLine.textContent = log;
            logContainer.appendChild(logLine);
            logContainer.scrollTop = logContainer.scrollHeight;
        });
        
        ipcRenderer.on('server-error', (event, error) => {
            const errorLine = document.createElement('div');
            errorLine.textContent = error;
            errorLine.style.color = '#ff5555';
            logContainer.appendChild(errorLine);
            logContainer.scrollTop = logContainer.scrollHeight;
        });
        
        ipcRenderer.on('settings-data', (event, data) => {
            twitchUsername.value = data.twitchUsername || '';
            twitchOAuthToken.value = data.twitchOAuthToken || '';
            portInput.value = data.port || 3001;
            autoStart.checked = data.autoStart || false;
            
            activities = data.activities || JSON.parse(JSON.stringify(defaultActivities));
            renderActivities();
            updateOverlayUrl();
        });
        
        ipcRenderer.on('settings-saved', () => {
            // Feedback visual que as configurações foram salvas
            const submitBtn = settingsForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            submitBtn.textContent = 'Salvo!';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }, 2000);
        });
        
        ipcRenderer.on('activities-saved', () => {
            // Feedback visual que as atividades foram salvas
            const originalText = saveActivitiesBtn.textContent;
            
            saveActivitiesBtn.textContent = 'Salvo!';
            saveActivitiesBtn.disabled = true;
            
            setTimeout(() => {
                saveActivitiesBtn.textContent = originalText;
                saveActivitiesBtn.disabled = false;
            }, 2000);
        });
        
        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 